# v1.1 Feature Plans — Review Addendum

Review of three executable XML plans by independent reviewer agents, with critical fixes applied.

## Plans Reviewed

| Plan | File | Tasks | Test Cases |
|------|------|-------|------------|
| Feature 1: Auth & Security | `v1.1-auth-security-plan.xml` | 21 | ~190 |
| Feature 2: Live APIs, Tiers, Credits | `v1.1-live-apis-tiers-credits-plan.xml` | 18 | ~160 |
| Feature 3: Voice, WebMCP, Agentic Testing | `v1.1-voice-webmcp-plan.xml` | 18 | ~190 |

## Execution Order

These plans have inter-dependencies and MUST be executed in order:

1. **Auth plan first** — creates the `users` table (migration 005), which Feature 2 and 3 depend on
2. **APIs/Tiers/Credits second** — creates credit system and tier gating (migration 006), references `users.id`
3. **Voice/WebMCP third** — depends on tier gating (Pro tier checks) from Feature 2

Each plan's branch should be merged to `main` before the next plan starts.

## Critical Fixes Applied

### Auth Plan (v1.1-auth-security-plan.xml)

| ID | Issue | Fix Applied |
|----|-------|-------------|
| CRIT-1/2 | `user_id` PK conflicts with fastapi-users expecting `id` | Renamed to `id`, UserModel extends `SQLAlchemyBaseUserTable[uuid.UUID]` |
| CRIT-3 | Dual plaintext + encrypted email is security theater | Replaced with blind index pattern: `email_hash` (HMAC-SHA256) + `encrypted_email` (Fernet) |
| CRIT-4 | `python-jose` + `fastapi-nextauth-jwt` conflict | Removed `python-jose`, using only `fastapi-nextauth-jwt` |
| CRIT-5 | Auth.js v5 cookie name differs in dev vs prod | Added dual cookie name check based on `Settings.environment` |
| CRIT-6 | Wiring auth breaks 351+ existing tests | Added `mock_current_user` / `authenticated_client` fixtures requirement |
| CRIT-7 | `next-auth@^5.0.0-beta` accepts breaking changes | Pinned to `next-auth@5.0.0-beta.25` + explicit `@auth/core` |
| CRIT-8 | Missing `tests/unit/auth/__init__.py` | Added directory creation to task 1.1 |
| WARN-4 | `BaseHTTPMiddleware` breaks SSE streaming | Changed to pure ASGI middleware |
| WARN-6 | `microphone=()` blocks voice feature | Changed to `microphone=(self)` |

### APIs/Tiers/Credits Plan (v1.1-live-apis-tiers-credits-plan.xml)

| ID | Issue | Fix Applied |
|----|-------|-------------|
| C1 | Duplicate rate limiter stacks with existing `etl/rate_limiter.py` | Clarified: new Valkey limiter replaces (not stacks) existing; fallback to in-process |
| C2 | Migration 006 depends on non-existent migration 005 | Made self-contained: creates stub `users` table if not exists |
| C3 | `SELECT FOR UPDATE` is no-op on SQLite | Marked concurrency test as `@pytest.mark.integration`, requires testcontainers |
| C4 | Generator dependency semantics unclear on empty results | Documented: credits consumed on non-exception completion including empty results |
| C5 | `CreditActionEnum` conflates enum values and costs | Split to StrEnum (names) + separate `CREDIT_COSTS` dict (millicredits) |
| C6 | `Sidebar.tsx` doesn't exist | Changed to `navigation.tsx` |
| W6 | Alembic can't discover new models | Added `alembic/env.py` import requirement |

### Voice/WebMCP Plan (v1.1-voice-webmcp-plan.xml)

| ID | Issue | Fix Applied |
|----|-------|-------------|
| C2/C3 | Task 4.2 built on non-existent WebMCP declarative APIs | Complete rewrite: imperative form bridge using `registerTool()` |
| C4 | `create_tts_service` name collision with `pipeline.py` | Renamed to `create_kokoro_tts_service` |
| C5 | `STTServiceProtocol.transcribe` returns `str`, tests expect object | Split: `transcribe() -> str` + `transcribe_detailed() -> TranscriptionResult` |
| C6 | `provideContext` semantics wrong (destructive vs additive) | Changed to `registerTool()` loop; documented clearing behavior |
| W2 | `AddBackgroundNoise` requires audio files, not synthetic | Replaced with `AddGaussianSNR` for presets without fixture audio |
| W7 | WebMCP camelCase vs CopilotKit snake_case mismatch | Added naming convention mapping in bridge |
| I6 | Spinner violates UX-first philosophy | Replaced with skeleton shimmer loader |

## Remaining Warnings (Not Fixed — Implementer Should Note)

### Auth Plan
- **WARN-1**: `email_hash` index should be UNIQUE (verify in migration)
- **WARN-2**: Development fallback encryption key is a security anti-pattern
- **WARN-3**: 5/min rate limit may be too aggressive for OAuth callbacks
- **WARN-8**: ORCID checksum validation is format-only (MOD 11-2 not implemented)
- **WARN-9**: `require_role("artist", "admin")` — admin is redundant due to hierarchy
- **WARN-11**: SameSite=Strict may break OAuth callback redirects (consider Lax + CSRF token)
- **IMP-4**: No account lockout after N failed attempts (OWASP recommendation)
- **IMP-5**: No password breach list checking (NIST SP 800-63B)

### APIs/Tiers/Credits Plan
- **W1**: `pylast` thread-safety with shared `Network` instance
- **W2**: `MusicApiClient` Protocol defined in two locations (use `protocols.py`)
- **W3**: Discogs uses personal access token, not full OAuth 1.0a
- **W4**: Stripe webhook route must NOT use Pydantic request model
- **W5**: Missing `stripe.api_key` initialization in app lifespan
- **W9**: Frontend tasks 5.2-5.4 depend on 5.1 atoms (implicit dependency)
- **I9**: Multi-source credit cost ambiguity (replace vs add individual costs)
- **I10**: No end-to-end integration test for full credit flow

### Voice/WebMCP Plan
- **W3**: WER thresholds may be unrealistic for TTS-to-STT round-trip (consider `xfail`)
- **W4**: `test_respects_prefers_reduced_motion` tests wrong abstraction level
- **W6**: CopilotKit `submitMessage` may not be the correct API name
- **W8**: `command_router.py` dispatch couples to PydanticAI Agent type
- **I1**: TTS fixture idempotency test may be flaky (floating-point non-determinism)
- **I2**: No TTS fallback to browser SpeechSynthesis when backend is down
- **I7**: Chrome version parsing from User-Agent is fragile (use `userAgentData`)

## Mode Override

All three plans require `creation` mode (up to 20 files, 1000 lines per task).
The project default is `maintenance` mode (3 files, 200 lines).
The executing agent must acknowledge the mode override before starting each plan.

## Companion Document

- **Voice synthesis comparison**: `v1.1-voice-synthesis-comparison.md` — detailed TTS engine comparison with architecture recommendations and audio degradation testing plan
