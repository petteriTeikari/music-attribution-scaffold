# Secrets Management
#
# How API keys, database credentials, and other secrets are stored
# and accessed.

decision_id: secrets_management
title: "Secrets Management"
description: >
  Determines how sensitive credentials (API keys, database passwords,
  encryption keys) are stored, rotated, and accessed by the application.
  The attribution/traceability domain handles permission data and potentially
  PII, making secrets management a compliance concern.

decision_level: L5_operations
status: active
last_updated: 2026-02-10

options:
  - option_id: environment_variables
    title: "Environment Variables"
    description: >
      Secrets stored as environment variables in the deployment
      platform (Render env vars, Railway variables). Simple, universal,
      no additional infrastructure. Current scaffold default.
    prior_probability: 0.40
    status: recommended

  - option_id: platform_secrets
    title: "Platform Secrets Manager (Doppler/Infisical)"
    description: >
      Dedicated secrets management platform with versioning, rotation,
      team access controls, and audit logging. Environment variables
      are injected at runtime.
    prior_probability: 0.20
    status: viable

  - option_id: cloud_secrets_manager
    title: "Cloud Secrets Manager (AWS/GCP)"
    description: >
      Cloud-native secrets management with IAM integration, automatic
      rotation, and encryption at rest. Tightly coupled with cloud
      compute platform.
    prior_probability: 0.20
    status: viable
    constraints:
      - "Cloud provider dependency"
      - "IAM configuration"
    complements:
      - "compute_platform.aws_ecs"

  - option_id: vault
    title: "HashiCorp Vault"
    description: >
      Self-hosted or managed secrets engine with dynamic credentials,
      PKI, and encryption as a service. Maximum capability, maximum
      operational complexity.
    prior_probability: 0.10
    status: deferred
    constraints:
      - "Vault operational expertise"
      - "Additional infrastructure"

  - option_id: dotenv_gitignored
    title: ".env Files (Gitignored)"
    description: >
      Secrets in .env files excluded from version control. Developer
      convenience for local development. Not suitable for production
      without additional tooling.
    prior_probability: 0.10
    status: viable

conditional_on:
  - parent_decision_id: regulatory_posture
    influence_strength: moderate
    conditional_table:
      - given_parent_option: best_effort
        then_probabilities:
          environment_variables: 0.50
          platform_secrets: 0.15
          cloud_secrets_manager: 0.10
          vault: 0.05
          dotenv_gitignored: 0.20
      - given_parent_option: compliance_aware
        then_probabilities:
          environment_variables: 0.35
          platform_secrets: 0.25
          cloud_secrets_manager: 0.20
          vault: 0.10
          dotenv_gitignored: 0.10
      - given_parent_option: compliance_first
        then_probabilities:
          environment_variables: 0.15
          platform_secrets: 0.25
          cloud_secrets_manager: 0.30
          vault: 0.25
          dotenv_gitignored: 0.05

  - parent_decision_id: compute_platform
    influence_strength: moderate
    conditional_table:
      - given_parent_option: render
        then_probabilities:
          environment_variables: 0.50
          platform_secrets: 0.20
          cloud_secrets_manager: 0.10
          vault: 0.05
          dotenv_gitignored: 0.15
      - given_parent_option: vercel_plus_backend
        then_probabilities:
          environment_variables: 0.45
          platform_secrets: 0.25
          cloud_secrets_manager: 0.10
          vault: 0.05
          dotenv_gitignored: 0.15
      - given_parent_option: railway
        then_probabilities:
          environment_variables: 0.50
          platform_secrets: 0.20
          cloud_secrets_manager: 0.10
          vault: 0.05
          dotenv_gitignored: 0.15
      - given_parent_option: fly_io
        then_probabilities:
          environment_variables: 0.45
          platform_secrets: 0.20
          cloud_secrets_manager: 0.10
          vault: 0.10
          dotenv_gitignored: 0.15
      - given_parent_option: hetzner_dedicated
        then_probabilities:
          environment_variables: 0.30
          platform_secrets: 0.15
          cloud_secrets_manager: 0.10
          vault: 0.25
          dotenv_gitignored: 0.20
      - given_parent_option: aws_ecs
        then_probabilities:
          environment_variables: 0.20
          platform_secrets: 0.15
          cloud_secrets_manager: 0.40
          vault: 0.15
          dotenv_gitignored: 0.10

archetype_weights:
  engineer_heavy_startup:
    probability_overrides:
      environment_variables: 0.30
      platform_secrets: 0.20
      cloud_secrets_manager: 0.20
      vault: 0.20
      dotenv_gitignored: 0.10
    rationale: "Engineers adopt secrets managers early for security."

  musician_first_team:
    probability_overrides:
      environment_variables: 0.50
      platform_secrets: 0.20
      cloud_secrets_manager: 0.05
      vault: 0.05
      dotenv_gitignored: 0.20
    rationale: "Environment variables are simple enough."

  solo_hacker:
    probability_overrides:
      environment_variables: 0.45
      platform_secrets: 0.10
      cloud_secrets_manager: 0.05
      vault: 0.05
      dotenv_gitignored: 0.35
    rationale: ".env for development, platform env vars for production."

  well_funded_startup:
    probability_overrides:
      environment_variables: 0.15
      platform_secrets: 0.25
      cloud_secrets_manager: 0.30
      vault: 0.20
      dotenv_gitignored: 0.10
    rationale: "Cloud secrets manager for compliance and audit trails."

volatility:
  classification: stable
  last_assessed: 2026-02-10
  next_review: 2026-05-10
  change_drivers:
    - "Compliance requirements from customers"
    - "Platform secrets management improvements"
    - "Credential rotation mandates"

domain_applicability:
  music_attribution: 1.0
  dpp_traceability: 1.0
  generic_graph_rag: 0.9

tags:
  - operations
  - security
  - secrets

references:
  - "../security/toc-security.md"
  - "../defaults.yaml"
