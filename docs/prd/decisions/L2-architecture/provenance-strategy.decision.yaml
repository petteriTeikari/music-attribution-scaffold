# Provenance Tracking Strategy
#
# Determines how the system tracks, stores, and exposes the full
# lineage of attribution data from source ingestion through to
# final confidence scores — the "Perplexity for music attribution"
# citation chain.
#
# Updated 2026-02-11: New decision node synthesizing research on
# OpenLineage, W3C PROV, C2PA, ISCC, and custom Pydantic approaches.
# Informed by 7 academic papers on uncertainty propagation in
# agentic systems (UProp, Beigi, Liu, Tian, Tripathi, Yáñez, Zhang).

decision_id: provenance_strategy
title: "Provenance & Citation Strategy"
description: >
  Determines the provenance tracking approach for the music attribution
  pipeline. Provenance answers "where did this confidence score come from?"
  by recording every data fetch, entity resolution, scoring step, and
  human review in a verifiable chain. The system must support:
  (1) per-step uncertainty decomposition (intrinsic vs extrinsic),
  (2) source reliability weighting with calibration quality,
  (3) Perplexity-like inline citations in the UI showing which
  sources contributed to each attribution claim,
  (4) export compatibility with industry standards (OpenLineage, C2PA).
  The core question: what level of provenance infrastructure is
  justified for an MVP vs. production deployment?

decision_level: L2_architecture
status: active
last_updated: 2026-02-11

options:
  - option_id: pydantic_provenance
    title: "Custom Pydantic Provenance Chain (Current)"
    description: >
      Extend the existing ProvenanceEvent discriminated union with
      uncertainty metadata (StepUncertainty, SourceContribution,
      CalibrationMetadata). Provenance stored as JSONB in
      attribution_records.provenance_chain. No external dependencies.
      Sufficient for MVP with Perplexity-like citation UI. Can export
      to OpenLineage format on demand without runtime dependency.
      Based on UProp (Duan 2025) intrinsic/extrinsic decomposition
      and Yáñez (2025) confidence-weighted source integration.
    prior_probability: 0.40
    status: recommended
    complements:
      - "primary_database.postgresql_unified"
      - "data_quality_strategy.pandera_statistical"

  - option_id: openlineage_native
    title: "OpenLineage Native (openlineage-python + Marquez)"
    description: >
      Full OpenLineage integration: emit RunEvents with custom facets
      (MaConfidenceRunFacet, MaUncertaintyRunFacet, MaCalibrationRunFacet,
      MaSourceReliabilityDatasetFacet) at every pipeline stage. Marquez
      backend for lineage visualization. ParentRunFacet chains ETL →
      Resolution → Attribution → API. openlineage-python 1.43.0
      (Apache 2.0, 100KB wheel). Justified when pipeline lineage
      visualization and cross-system interoperability are required.
    prior_probability: 0.25
    status: viable
    complements:
      - "schema_governance.dvc_plus_json_schema"
      - "observability_stack.opentelemetry"
    constraints:
      - "Marquez infrastructure (Docker: Java 17 + PostgreSQL + React UI)"
      - "Custom facet JSON Schema hosting for validation"
      - "Ongoing Marquez maintenance overhead"

  - option_id: w3c_prov_model
    title: "W3C PROV Data Model (prov library)"
    description: >
      Formal W3C PROV ontology via prov Python library (v2.1.1, MIT,
      Beta status). Models provenance as Entity-Activity-Agent triples
      with derivation chains. Serializes to PROV-N, PROV-JSON, PROV-XML,
      PROV-O (RDF). NetworkX graph conversion for analysis. Strongest
      semantic interoperability with academic/government systems.
      Justified for regulatory compliance or multi-organization data
      exchange scenarios.
    prior_probability: 0.15
    status: viable
    complements:
      - "regulatory_posture.compliance_first"
    constraints:
      - "Academic/standards-heavy approach — steeper learning curve"
      - "prov library in Beta status (2.1.1, June 2025)"
      - "RDF serialization adds complexity without clear MVP benefit"

  - option_id: c2pa_embedded
    title: "C2PA Manifests (Content Credentials)"
    description: >
      Embed C2PA content credentials directly in audio files using
      c2pa-python (v0.28.0, Jan 2026, MIT/Apache 2.0). Cryptographic
      chain of trust from creator through distributor. CAWG identity
      assertions for creator attribution. Strongest for file-level
      provenance when audio files are the primary distribution channel.
      Does NOT replace pipeline-level provenance — complements it
      for the final "last mile" of attribution delivery.
    prior_probability: 0.10
    status: deferred
    complements:
      - "provenance_strategy.pydantic_provenance"
    constraints:
      - "Requires audio file manipulation (not just metadata)"
      - "C2PA audio support still maturing (spec v2.2, April 2025)"
      - "Signing infrastructure (X.509 certificates)"
      - "File-level only — doesn't track pipeline-internal provenance"

  - option_id: hybrid_pydantic_openlineage
    title: "Hybrid (Pydantic MVP + OpenLineage Export)"
    description: >
      Pydantic provenance chain as primary store (same as pydantic_provenance)
      with an export adapter that converts provenance chains to OpenLineage
      RunEvents on demand. No runtime dependency on OpenLineage — only
      used for export/integration. Best of both worlds: simple MVP with
      standards-compatible export path. Can add Marquez visualization
      later without schema changes.
    prior_probability: 0.10
    status: viable
    complements:
      - "provenance_strategy.pydantic_provenance"
      - "schema_governance.git_schema_versioning"

conditional_on:
  - parent_decision_id: build_vs_buy_posture
    influence_strength: moderate
    conditional_table:
      - given_parent_option: custom_build
        then_probabilities:
          pydantic_provenance: 0.30
          openlineage_native: 0.30
          w3c_prov_model: 0.15
          c2pa_embedded: 0.10
          hybrid_pydantic_openlineage: 0.15
      - given_parent_option: managed_services
        then_probabilities:
          pydantic_provenance: 0.35
          openlineage_native: 0.25
          w3c_prov_model: 0.15
          c2pa_embedded: 0.10
          hybrid_pydantic_openlineage: 0.15
      - given_parent_option: saas_maximalist
        then_probabilities:
          pydantic_provenance: 0.45
          openlineage_native: 0.15
          w3c_prov_model: 0.10
          c2pa_embedded: 0.15
          hybrid_pydantic_openlineage: 0.15

  - parent_decision_id: regulatory_posture
    influence_strength: strong
    conditional_table:
      - given_parent_option: compliance_first
        then_probabilities:
          pydantic_provenance: 0.15
          openlineage_native: 0.25
          w3c_prov_model: 0.30
          c2pa_embedded: 0.15
          hybrid_pydantic_openlineage: 0.15
      - given_parent_option: compliance_aware
        then_probabilities:
          pydantic_provenance: 0.35
          openlineage_native: 0.25
          w3c_prov_model: 0.15
          c2pa_embedded: 0.10
          hybrid_pydantic_openlineage: 0.15
      - given_parent_option: best_effort
        then_probabilities:
          pydantic_provenance: 0.50
          openlineage_native: 0.15
          w3c_prov_model: 0.05
          c2pa_embedded: 0.10
          hybrid_pydantic_openlineage: 0.20

  - parent_decision_id: data_model_complexity
    influence_strength: moderate
    conditional_table:
      - given_parent_option: graph_enriched_relational
        then_probabilities:
          pydantic_provenance: 0.30
          openlineage_native: 0.30
          w3c_prov_model: 0.15
          c2pa_embedded: 0.05
          hybrid_pydantic_openlineage: 0.20
      - given_parent_option: simple_relational
        then_probabilities:
          pydantic_provenance: 0.50
          openlineage_native: 0.15
          w3c_prov_model: 0.10
          c2pa_embedded: 0.10
          hybrid_pydantic_openlineage: 0.15
      - given_parent_option: full_knowledge_graph
        then_probabilities:
          pydantic_provenance: 0.20
          openlineage_native: 0.35
          w3c_prov_model: 0.20
          c2pa_embedded: 0.05
          hybrid_pydantic_openlineage: 0.20
      - given_parent_option: document_centric
        then_probabilities:
          pydantic_provenance: 0.45
          openlineage_native: 0.15
          w3c_prov_model: 0.15
          c2pa_embedded: 0.10
          hybrid_pydantic_openlineage: 0.15

archetype_weights:
  engineer_heavy_startup:
    probability_overrides:
      pydantic_provenance: 0.25
      openlineage_native: 0.35
      w3c_prov_model: 0.10
      c2pa_embedded: 0.10
      hybrid_pydantic_openlineage: 0.20
    rationale: >
      Engineers can manage OpenLineage infrastructure and will want
      lineage visualization for debugging complex pipelines.

  musician_first_team:
    probability_overrides:
      pydantic_provenance: 0.50
      openlineage_native: 0.10
      w3c_prov_model: 0.05
      c2pa_embedded: 0.20
      hybrid_pydantic_openlineage: 0.15
    rationale: >
      Keep it simple. Musicians care about C2PA (embedded in their
      audio files) more than pipeline lineage tooling.

  solo_hacker:
    probability_overrides:
      pydantic_provenance: 0.45
      openlineage_native: 0.10
      w3c_prov_model: 0.05
      c2pa_embedded: 0.10
      hybrid_pydantic_openlineage: 0.30
    rationale: >
      Pydantic provenance for MVP, hybrid export for portfolio value.
      OpenLineage infrastructure is overkill for solo projects.

  well_funded_startup:
    probability_overrides:
      pydantic_provenance: 0.15
      openlineage_native: 0.35
      w3c_prov_model: 0.15
      c2pa_embedded: 0.15
      hybrid_pydantic_openlineage: 0.20
    rationale: >
      Can afford Marquez infrastructure. OpenLineage provides
      investor-facing lineage story and production observability.

volatility:
  classification: shifting
  last_assessed: 2026-02-11
  next_review: 2026-04-11
  change_drivers:
    - "OpenLineage spec evolution (currently 2-0-2)"
    - "C2PA v2.x audio support maturation"
    - "CAWG identity assertion standardization"
    - "W3C PROV adoption in music industry"
    - "EU AI Act provenance requirements timeline"
    - "ISCC (ISO 24138:2024) adoption for content identification"
    - "LLM-native provenance patterns (agentic calibration)"

domain_applicability:
  music_attribution: 1.0
  dpp_traceability: 0.9
  generic_graph_rag: 0.6

tags:
  - architecture
  - provenance
  - lineage
  - citations
  - uncertainty
  - calibration

rationale: >
  Provenance tracking is the core differentiator of the music attribution
  scaffold. Unlike simple confidence scores, the system must answer "WHY
  do we believe this attribution?" with a verifiable chain of evidence.
  This is the "Perplexity for music" concept: every attribution claim is
  backed by inline citations showing which sources (MusicBrainz, Discogs,
  AcoustID, artist input, file metadata) contributed, with what confidence,
  and how that confidence was calibrated.

  Academic grounding: UProp (Duan 2025, arXiv:2506.17419) provides the
  intrinsic/extrinsic uncertainty decomposition for multi-step pipelines.
  Yáñez (2025, Patterns) provides confidence-weighted integration of
  human and machine sources. Zhang (2026, arXiv:2601.15778) provides
  trajectory-level calibration (HTC) for end-to-end confidence. Tian
  (2025, arXiv:2508.06225) and Tripathi (2025, arXiv:2506.23464) provide
  overconfidence detection mechanisms.

  For the MVP, custom Pydantic provenance is recommended: zero external
  dependencies, stores alongside existing JSONB provenance_chain, and
  supports Perplexity-like citation UI. The schema is designed to be
  export-compatible with OpenLineage (custom facets map 1:1 to Pydantic
  fields) so migration to native OpenLineage is non-breaking.

references:
  - "https://arxiv.org/abs/2506.17419"  # UProp
  - "https://arxiv.org/abs/2410.20199"  # Beigi uncertainty review
  - "https://arxiv.org/abs/2503.15850"  # Liu UQ survey
  - "https://arxiv.org/abs/2508.06225"  # Tian overconfidence
  - "https://arxiv.org/abs/2506.23464"  # Tripathi confidence paradox
  - "https://arxiv.org/abs/2601.15778"  # Zhang agentic calibration
  - "https://openlineage.io/docs/spec/object-model/"
  - "https://www.w3.org/TR/prov-dm/"
  - "https://c2pa.org/"
  - "https://iscc.codes/"
